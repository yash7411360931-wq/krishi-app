import React, { useState, useRef, useEffect } from 'react';
import { Mic, MicOff, Send, Image, History, Trash2, Globe, Download, Share2 } from 'lucide-react';

interface Message {
  id: string;
  type: 'user' | 'ai';
  content: string;
  timestamp: Date;
  imageUrl?: string;
  isAnalysis?: boolean;
}

const App = () => {
  const [messages, setMessages] = useState<Message[]>([]);
  const [inputText, setInputText] = useState('');
  const [isListening, setIsListening] = useState(false);
  const [language, setLanguage] = useState<'hi' | 'en'>('hi');
  const [showHistory, setShowHistory] = useState(false);
  const [selectedImage, setSelectedImage] = useState<string | null>(null);
  const [isProcessing, setIsProcessing] = useState(false);
  const [lastAnalysis, setLastAnalysis] = useState<string | null>(null);
  
  const recognitionRef = useRef<any>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  
  const API_KEY = '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';

  useEffect(() => {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = (window as any).webkitSpeechRecognition || (window as any).SpeechRecognition;
      recognitionRef.current = new SpeechRecognition();
      recognitionRef.current.continuous = false;
      recognitionRef.current.interimResults = false;
      recognitionRef.current.lang = language === 'hi' ? 'hi-IN' : 'en-US';

      recognitionRef.current.onresult = (event: any) => {
        const transcript = event.results[0][0].transcript;
        setInputText(transcript);
        setIsListening(false);
      };

      recognitionRef.current.onerror = () => setIsListening(false);
      recognitionRef.current.onend = () => setIsListening(false);
    }
  }, [language]);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  const toggleListening = () => {
    if (isListening) {
      recognitionRef.current?.stop();
      setIsListening(false);
    } else {
      recognitionRef.current?.start();
      setIsListening(true);
    }
  };

  const speakText = (text: string) => {
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = language === 'hi' ? 'hi-IN' : 'en-US';
      utterance.rate = 0.9;
      window.speechSynthesis.speak(utterance);
    }
  };

  const generateAIResponse = async (userMessage: string, imageUrl?: string): Promise<string> => {
    if (imageUrl) {
      try {
        const base64Image = imageUrl.split(',')[1];
        const mimeType = imageUrl.split(';')[0].split(':')[1];
        
        const prompt = language === 'hi' 
          ? `‡§á‡§∏ ‡§™‡•å‡§ß‡•á/‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§´‡•ã‡§ü‡•ã ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§®‡§ø‡§¶‡§æ‡§® ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç:

1. ‡§∞‡•ã‡§ó ‡§ï‡§æ ‡§®‡§æ‡§Æ: ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§∞‡•ã‡§ó ‡§ï‡•Ä ‡§™‡§π‡§ö‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç (‡§Ø‡§¶‡§ø ‡§ï‡•ã‡§à ‡§π‡•ã)
2. ‡§≤‡§ï‡•ç‡§∑‡§£: ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§≤‡§ï‡•ç‡§∑‡§£‡•ã‡§Ç ‡§ï‡§æ ‡§µ‡§∞‡•ç‡§£‡§® ‡§ï‡§∞‡•á‡§Ç
3. ‡§â‡§™‡§ö‡§æ‡§∞: ‡§â‡§™‡§ö‡§æ‡§∞ ‡§ï‡•á ‡§§‡§∞‡•Ä‡§ï‡•á ‡§∏‡•Å‡§ù‡§æ‡§è‡§Ç (‡§ú‡•à‡§µ‡§ø‡§ï ‡§î‡§∞ ‡§∞‡§æ‡§∏‡§æ‡§Ø‡§®‡§ø‡§ï ‡§¶‡•ã‡§®‡•ã‡§Ç)
4. ‡§ú‡§≤‡§µ‡§æ‡§Ø‡•Å: ‡§á‡§∏ ‡§∞‡•ã‡§ó ‡§ï‡•ã ‡§∞‡•ã‡§ï‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§¶‡§∞‡•ç‡§∂ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø‡§Ø‡§æ‡§Ç
5. ‡§∞‡•ã‡§ï‡§•‡§æ‡§Æ: ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§Æ‡•á‡§Ç ‡§∞‡•ã‡§ï‡§®‡•á ‡§ï‡•á ‡§ü‡§ø‡§™‡•ç‡§∏

‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§Ç‡•§`
          : `Analyze this plant/crop image and provide a detailed diagnosis:

1. Disease Name: Identify the specific disease (if any)
2. Symptoms: Describe visible symptoms
3. Treatment: Recommend treatment methods (both organic and chemical)
4. Climate: Ideal conditions to prevent this disease
5. Prevention: Tips to prevent future occurrences

Format the response clearly with headings in English.`;

        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${API_KEY}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            model: 'anthropic/claude-3.5-sonnet',
            messages: [{
              role: 'user',
              content: [
                { type: 'text', text: prompt },
                { type: 'image_url', image_url: { url: `data:${mimeType};base64,${base64Image}` }}
              ]
            }]
          })
        });

        if (!response.ok) throw new Error(`API Error: ${response.status}`);

        const data = await response.json();
        
        if (data.choices?.[0]?.message) {
          const analysis = data.choices[0].message.content;
          setLastAnalysis(analysis);
          return analysis;
        }
        throw new Error('Invalid response format');
      } catch (error) {
        console.error('Image analysis error:', error);
        return language === 'hi' 
          ? '‚ùå ‡§´‡•ã‡§ü‡•ã ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§'
          : '‚ùå Error analyzing image. Please try again.';
      }
    }

    try {
      const systemPrompt = language === 'hi'
        ? '‡§Ü‡§™ ‡§è‡§ï ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§ï‡•É‡§∑‡§ø ‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞ ‡§π‡•à‡§Ç‡•§ ‡§ï‡§ø‡§∏‡§æ‡§®‡•ã‡§Ç ‡§ï‡•ã ‡§ñ‡•á‡§§‡•Ä, ‡§´‡§∏‡§≤, ‡§Æ‡•å‡§∏‡§Æ, ‡§ï‡•Ä‡§ü ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§î‡§∞ ‡§™‡•å‡§ß‡•ã‡§Ç ‡§ï‡•Ä ‡§¨‡•Ä‡§Æ‡§æ‡§∞‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§î‡§∞ ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§∏‡§≤‡§æ‡§π ‡§¶‡•á‡§Ç‡•§ ‡§π‡§Æ‡•á‡§∂‡§æ ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§Ç‡•§'
        : 'You are an expert agricultural advisor. Provide helpful and detailed advice to farmers about farming, crops, weather, pest control, and plant diseases. Always respond in English.';

      const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${API_KEY}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'anthropic/claude-3.5-sonnet',
          messages: [
            { role: 'system', content: systemPrompt },
            { role: 'user', content: userMessage }
          ]
        })
      });

      if (!response.ok) throw new Error(`API Error: ${response.status}`);
      const data = await response.json();
      
      if (data.choices?.[0]?.message) {
        return data.choices[0].message.content;
      }
      throw new Error('Invalid response format');
    } catch (error) {
      console.error('AI response error:', error);
      
      const lowerMessage = userMessage.toLowerCase();
      
      if (language === 'hi') {
        if (lowerMessage.includes('‡§Æ‡•å‡§∏‡§Æ') || lowerMessage.includes('‡§¨‡§æ‡§∞‡§ø‡§∂')) {
          return '‡§Ü‡§ú ‡§ï‡§æ ‡§Æ‡•å‡§∏‡§Æ ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§π‡•à‡•§ ‡§Ö‡§ó‡§≤‡•á 3 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§π‡§≤‡•ç‡§ï‡•Ä ‡§¨‡§æ‡§∞‡§ø‡§∂ ‡§ï‡•Ä ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§®‡§æ ‡§π‡•à‡•§ ‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π ‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§∏‡§Æ‡§Ø ‡§π‡•à‡•§';
        } else if (lowerMessage.includes('‡§´‡§∏‡§≤') || lowerMessage.includes('‡§ñ‡•á‡§§‡•Ä')) {
          return '‡§á‡§∏ ‡§Æ‡•å‡§∏‡§Æ ‡§Æ‡•á‡§Ç ‡§ó‡•á‡§π‡•Ç‡§Ç ‡§î‡§∞ ‡§∏‡§∞‡§∏‡•ã‡§Ç ‡§ï‡•Ä ‡§ñ‡•á‡§§‡•Ä ‡§Ö‡§ö‡•ç‡§õ‡•Ä ‡§∞‡§π‡§§‡•Ä ‡§π‡•à‡•§ ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ï‡•Ä ‡§ú‡§æ‡§Ç‡§ö ‡§ï‡§∞‡§µ‡§æ‡§®‡§æ ‡§® ‡§≠‡•Ç‡§≤‡•á‡§Ç‡•§';
        } else {
          return '‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡§¶‡§¶ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Ç ‡§π‡•Ç‡§Ç‡•§ ‡§Ü‡§™ ‡§Æ‡•Å‡§ù‡§∏‡•á ‡§Æ‡•å‡§∏‡§Æ, ‡§´‡§∏‡§≤, ‡§ï‡•Ä‡§ü ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ ‡§Ø‡§æ ‡§ñ‡•á‡§§‡•Ä ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§∏‡§µ‡§æ‡§≤ ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§';
        }
      } else {
        if (lowerMessage.includes('weather') || lowerMessage.includes('rain')) {
          return 'The weather today is good. There is a possibility of light rain in the next 3 days. This is a good time for crop irrigation.';
        } else if (lowerMessage.includes('crop') || lowerMessage.includes('farming')) {
          return 'Wheat and mustard cultivation is good this season. Don\'t forget to get your soil tested.';
        } else {
          return 'I am here to help you. You can ask me any questions about weather, crops, pest control or farming.';
        }
      }
    }
  };

  const handleSendMessage = async () => {
    if (!inputText.trim() && !selectedImage) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      type: 'user',
      content: inputText || (language === 'hi' ? '‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§≠‡•á‡§ú‡•Ä' : 'Image sent'),
      timestamp: new Date(),
      imageUrl: selectedImage || undefined
    };

    setMessages(prev => [...prev, userMessage]);
    setInputText('');
    setIsProcessing(true);

    const aiResponse = await generateAIResponse(inputText, selectedImage || undefined);
    
    const aiMessage: Message = {
      id: (Date.now() + 1).toString(),
      type: 'ai',
      content: aiResponse,
      timestamp: new Date(),
      isAnalysis: !!selectedImage
    };

    setMessages(prev => [...prev, aiMessage]);
    speakText(aiResponse);
    setSelectedImage(null);
    setIsProcessing(false);
  };

  const handleImageUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setSelectedImage(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  const downloadReport = () => {
    if (!lastAnalysis) {
      alert(language === 'hi' ? '‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§®‡§π‡•Ä‡§Ç‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§´‡•ã‡§ü‡•ã ‡§≠‡•á‡§ú‡•á‡§Ç‡•§' : 'No analysis to download. Please send an image first.');
      return;
    }

    const blob = new Blob([lastAnalysis], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `plant-analysis-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const shareReport = async () => {
    if (!lastAnalysis) {
      alert(language === 'hi' ? '‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§®‡§π‡•Ä‡§Ç‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§´‡•ã‡§ü‡•ã ‡§≠‡•á‡§ú‡•á‡§Ç‡•§' : 'No analysis to share. Please send an image first.');
      return;
    }

    if (navigator.share) {
      try {
        await navigator.share({
          title: language === 'hi' ? '‡§™‡•å‡§ß‡•á ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£' : 'Plant Analysis',
          text: lastAnalysis
        });
      } catch (err) {
        console.log('Share failed:', err);
      }
    } else {
      try {
        await navigator.clipboard.writeText(lastAnalysis);
        alert(language === 'hi' ? '‚úÖ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§à!' : '‚úÖ Report copied to clipboard!');
      } catch (err) {
        console.error('Copy failed:', err);
      }
    }
  };

  const clearHistory = () => {
    setMessages([]);
    setShowHistory(false);
  };

  const toggleLanguage = () => {
    setLanguage(prev => prev === 'hi' ? 'en' : 'hi');
    if (recognitionRef.current) {
      recognitionRef.current.lang = language === 'hi' ? 'en-US' : 'hi-IN';
    }
  };

  const translations = {
    hi: {
      title: '‡§ï‡§ø‡§∏‡§æ‡§® ‡§∏‡§π‡§æ‡§Ø‡§ï',
      subtitle: '‡§Ü‡§™‡§ï‡§æ AI ‡§ñ‡•á‡§§‡•Ä ‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞',
      placeholder: '‡§Ö‡§™‡§®‡§æ ‡§∏‡§µ‡§æ‡§≤ ‡§™‡•Ç‡§õ‡•á‡§Ç...',
      send: '‡§≠‡•á‡§ú‡•á‡§Ç',
      history: '‡§á‡§§‡§ø‡§π‡§æ‡§∏',
      clearHistory: '‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç',
      noMessages: '‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§®‡§π‡•Ä‡§Ç',
      processing: '‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
      listening: '‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Ç...',
    },
    en: {
      title: 'Farmer Assistant',
      subtitle: 'Your AI Farming Advisor',
      placeholder: 'Ask your question...',
      send: 'Send',
      history: 'History',
      clearHistory: 'Clear History',
      noMessages: 'No messages yet',
      processing: 'Processing...',
      listening: 'Listening...',
    }
  };

  const t = translations[language];

  return (
    <div className="min-h-screen relative overflow-hidden bg-gradient-to-br from-green-50 via-emerald-50 to-lime-50">
      {/* Animated Background Elements */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        {/* Floating wheat stalks */}
        <div className="absolute top-10 left-10 text-6xl opacity-10 animate-pulse">üåæ</div>
        <div className="absolute top-40 right-20 text-5xl opacity-8 animate-bounce" style={{animationDuration: '3s'}}>üåø</div>
        <div className="absolute bottom-20 left-1/4 text-7xl opacity-5 animate-pulse" style={{animationDelay: '1s'}}>üåæ</div>
        <div className="absolute top-1/3 right-10 text-6xl opacity-10 animate-bounce" style={{animationDuration: '4s', animationDelay: '0.5s'}}>üå±</div>
        <div className="absolute bottom-40 right-1/3 text-5xl opacity-12 animate-pulse" style={{animationDelay: '2s'}}>üçÉ</div>
        <div className="absolute top-20 left-1/3 text-4xl opacity-8 animate-bounce" style={{animationDuration: '5s'}}>üåæ</div>
        <div className="absolute bottom-10 left-20 text-6xl opacity-10 animate-pulse" style={{animationDelay: '1.5s'}}>üåø</div>
        <div className="absolute top-1/2 left-10 text-5xl opacity-8 animate-bounce" style={{animationDuration: '3.5s'}}>üå±</div>
        
        {/* Gradient overlays - lighter colors */}
        <div className="absolute top-0 left-0 w-96 h-96 bg-green-200 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
        <div className="absolute bottom-0 right-0 w-96 h-96 bg-emerald-200 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style={{animationDelay: '2s'}}></div>
        <div className="absolute top-1/2 left-1/2 w-96 h-96 bg-lime-200 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style={{animationDelay: '4s'}}></div>
        
        {/* Decorative lines */}
        <svg className="absolute inset-0 w-full h-full opacity-5">
          <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="currentColor" strokeWidth="0.5" className="text-green-300"/>
          </pattern>
          <rect width="100%" height="100%" fill="url(#grid)" />
        </svg>
      </div>

      <div className="container mx-auto px-4 py-6 max-w-6xl relative z-10">
        {/* Header */}
        <div className="bg-white/90 backdrop-blur-xl rounded-3xl shadow-xl p-6 mb-6 border border-green-100">
          <div className="flex items-center justify-between flex-wrap gap-4">
            <div className="flex items-center gap-4">
              <div className="w-16 h-16 bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl flex items-center justify-center text-3xl shadow-lg transform hover:scale-110 transition-transform">
                üåæ
              </div>
              <div>
                <h1 className="text-3xl font-bold bg-gradient-to-r from-green-600 via-emerald-600 to-lime-600 bg-clip-text text-transparent">
                  {t.title}
                </h1>
                <p className="text-gray-600">{t.subtitle}</p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              {lastAnalysis && (
                <>
                  <button
                    onClick={downloadReport}
                    className="p-2 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 transition-all hover:scale-110"
                    title={language === 'hi' ? '‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç' : 'Download Report'}
                  >
                    <Download className="w-5 h-5" />
                  </button>
                  <button
                    onClick={shareReport}
                    className="p-2 rounded-lg bg-purple-50 text-purple-600 hover:bg-purple-100 transition-all hover:scale-110"
                    title={language === 'hi' ? '‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç' : 'Share Report'}
                  >
                    <Share2 className="w-5 h-5" />
                  </button>
                </>
              )}
              <button
                onClick={toggleLanguage}
                className="p-2 rounded-lg bg-green-50 text-green-600 hover:bg-green-100 transition-all hover:scale-110"
                title={language === 'hi' ? 'Switch to English' : '‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç'}
              >
                <Globe className="w-5 h-5" />
              </button>
              <button
                onClick={() => setShowHistory(!showHistory)}
                className="p-2 rounded-lg bg-green-50 text-green-600 hover:bg-green-100 transition-all hover:scale-110"
                title={t.history}
              >
                <History className="w-5 h-5" />
              </button>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Chat Area */}
          <div className={showHistory ? 'lg:col-span-2' : 'lg:col-span-3'}>
            <div className="bg-white/90 backdrop-blur-xl rounded-3xl shadow-xl overflow-hidden border border-green-100">
              {/* Messages */}
              <div className="h-[600px] overflow-y-auto p-6 space-y-4 bg-gradient-to-b from-white/50 to-green-50/30">
                {messages.length === 0 ? (
                  <div className="h-full flex items-center justify-center text-gray-400">
                    <div className="text-center">
                      <div className="text-6xl mb-4 animate-bounce">üí¨</div>
                      <p className="text-lg text-gray-600">{t.noMessages}</p>
                      <p className="text-sm mt-2 text-gray-500">Upload an image or ask a question!</p>
                    </div>
                  </div>
                ) : (
                  messages.map((message) => (
                    <div key={message.id} className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'} animate-fadeIn`}>
                      <div className={`max-w-[80%] rounded-2xl px-4 py-3 transform hover:scale-[1.02] transition-all ${
                        message.type === 'user'
                          ? 'bg-gradient-to-br from-green-400 to-emerald-500 text-white shadow-md'
                          : message.isAnalysis
                          ? 'bg-gradient-to-br from-blue-50 to-purple-50 text-gray-800 shadow-md border-2 border-blue-200'
                          : 'bg-white text-gray-800 shadow-md border border-gray-100'
                      }`}>
                        {message.imageUrl && (
                          <img src={message.imageUrl} alt="Uploaded" className="rounded-lg mb-2 max-w-full h-auto shadow-sm" />
                        )}
                        {message.isAnalysis && (
                          <div className="flex items-center gap-2 mb-2 pb-2 border-b border-blue-200">
                            <span className="text-lg animate-pulse">üî¨</span>
                            <span className="text-xs font-semibold text-blue-700">
                              {language === 'hi' ? '‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£' : 'Detailed Analysis'}
                            </span>
                          </div>
                        )}
                        <p className="text-sm leading-relaxed whitespace-pre-wrap">{message.content}</p>
                        <p className={`text-xs mt-1 ${message.type === 'user' ? 'text-green-50' : 'text-gray-500'}`}>
                          {message.timestamp.toLocaleTimeString(language === 'hi' ? 'hi-IN' : 'en-US', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                          })}
                        </p>
                      </div>
                    </div>
                  ))
                )}
                {isProcessing && (
                  <div className="flex justify-start animate-fadeIn">
                    <div className="bg-white rounded-2xl px-4 py-3 shadow-md border border-gray-100">
                      <div className="flex items-center gap-2">
                        <div className="w-2 h-2 bg-green-500 rounded-full animate-bounce" />
                        <div className="w-2 h-2 bg-green-500 rounded-full animate-bounce" style={{animationDelay: '0.1s'}} />
                        <div className="w-2 h-2 bg-green-500 rounded-full animate-bounce" style={{animationDelay: '0.2s'}} />
                        <span className="ml-2 text-sm text-gray-600">{t.processing}</span>
                      </div>
                    </div>
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>

              {/* Input Area */}
              <div className="border-t border-gray-100 p-4 bg-white/80 backdrop-blur-sm">
                {selectedImage && (
                  <div className="mb-3 relative inline-block animate-fadeIn">
                    <img src={selectedImage} alt="Selected" className="h-20 rounded-lg shadow-md" />
                    <button
                      onClick={() => setSelectedImage(null)}
                      className="absolute -top-2 -right-2 bg-red-400 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-500 hover:scale-110 transition-all shadow-md"
                    >
                      √ó
                    </button>
                  </div>
                )}
                <div className="flex items-center gap-2">
                  <input
                    type="file"
                    ref={fileInputRef}
                    onChange={handleImageUpload}
                    accept="image/*"
                    className="hidden"
                  />
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="p-3 rounded-xl bg-gray-50 text-gray-700 hover:bg-gray-100 transition-all hover:scale-110 shadow-sm border border-gray-200"
                  >
                    <Image className="w-5 h-5" />
                  </button>
                  <button
                    onClick={toggleListening}
                    className={`p-3 rounded-xl transition-all hover:scale-110 shadow-sm border ${
                      isListening
                        ? 'bg-red-400 text-white hover:bg-red-500 animate-pulse border-red-400'
                        : 'bg-gray-50 text-gray-700 hover:bg-gray-100 border-gray-200'
                    }`}
                  >
                    {isListening ? <MicOff className="w-5 h-5" /> : <Mic className="w-5 h-5" />}
                  </button>
                  <input
                    type="text"
                    value={inputText}
                    onChange={(e) => setInputText(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                    placeholder={isListening ? t.listening : t.placeholder}
                    className="flex-1 px-4 py-3 rounded-xl bg-white border border-gray-200 focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-transparent shadow-sm transition-all"
                    disabled={isListening}
                  />
                  <button
                    onClick={handleSendMessage}
                    disabled={(!inputText.trim() && !selectedImage) || isProcessing}
                    className="p-3 rounded-xl bg-gradient-to-r from-green-400 to-emerald-500 text-white hover:from-green-500 hover:to-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:scale-110 shadow-md"
                  >
                    <Send className="w-5 h-5" />
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* History Sidebar */}
          {showHistory && (
            <div className="bg-white/90 backdrop-blur-xl rounded-3xl shadow-xl p-6 border border-green-100 animate-fadeIn">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold text-gray-800">{t.history}</h2>
                <button
                  onClick={clearHistory}
                  className="p-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-all hover:scale-110"
                  title={t.clearHistory}
                >
                  <Trash2 className="w-4 h-4" />
                </button>
              </div>
              <div className="space-y-3 max-h-[600px] overflow-y-auto">
                {messages.map((message) => (
                  <div key={message.id} className="p-3 rounded-lg bg-gradient-to-br from-white to-green-50/50 border border-gray-100 hover:shadow-md transition-all hover:scale-[1.02]">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="text-lg">{message.type === 'user' ? 'üë§' : 'ü§ñ'}</span>
                      <span className="text-xs text-gray-500">
                        {message.timestamp.toLocaleTimeString(language === 'hi' ? 'hi-IN' : 'en-US')}
                      </span>
                    </div>
                    {message.imageUrl && (
                      <img src={message.imageUrl} alt="History" className="w-full h-20 object-cover rounded mb-2 shadow-sm" />
                    )}
                    <p className="text-sm text-gray-700 line-clamp-3">
                      {message.content}
                    </p>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>

      <style>{`
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(10px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .animate-fadeIn {
          animation: fadeIn 0.3s ease-out;
        }
      `}</style>
    </div>
  );
};

export default App;